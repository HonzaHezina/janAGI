{
  "name": "janAGI • Spec-Kit • Refine & Execute (OpenClaw-led)",
  "nodes": [
    {
      "parameters": {
        "path": "janagi/spec/flow",
        "httpMethod": "POST",
        "responseMode": "lastNode"
      },
      "id": "Webhook",
      "name": "Webhook (Message In)",
      "type": "n8n-nodes-base.webhook",
      "typeVersion": 2,
      "position": [100, 300]
    },
    {
      "parameters": {
        "mode": "runOnceForEachItem",
        "jsCode": "const b = $json.body || $json;\nconst app = (b.app_name || 'spec-app').toLowerCase().replace(/[^a-z0-9-]/g,'-');\nconst run_id = b.run_id || `run-${Date.now()}-${Math.random().toString(16).slice(2,8)}`;\nconst root = process.env.WORK_ROOT || '/data/janagi-builds';\nconst run_dir = `${root}/${app}/runs/${run_id}`;\n\nreturn [{\n  app_name: app,\n  run_id: run_id,\n  run_dir: run_dir,\n  user_message: b.message || b.intent || '',\n  force_execute: b.force_execute || false,\n  github_owner: process.env.GITHUB_OWNER || '',\n  defaults: {\n    visibility: b.visibility || 'private',\n    primary: b.primary || 'both',\n    template: b.template || 'fastapi'\n  },\n  logs: {\n    openclaw: `${run_dir}/openclaw.log`,\n    gemini: `${run_dir}/gemini.log`,\n    copilot: `${run_dir}/copilot.log`\n  }\n}];"
      },
      "id": "Context",
      "name": "Init Context",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [300, 300]
    },
    {
      "parameters": {
        "command": "bash",
        "input": "-lc",
        "args": "set -euo pipefail\nmkdir -p \"{{$json.run_dir}}\"\n\n: > \"{{$json.logs.openclaw}}\"\n: > \"{{$json.logs.gemini}}\"\n: > \"{{$json.logs.copilot}}\"\n\nCONTEXT_FILE=\"{{$json.run_dir}}/context.json\"\nLOCKED_FILE=\"{{$json.run_dir}}/locked.json\"\n\nif [ ! -f \"$CONTEXT_FILE\" ]; then echo '{}' > \"$CONTEXT_FILE\"; fi\n\nSTATE=\"refine\"\nif [ -f \"$LOCKED_FILE\" ] || [ \"{{$json.force_execute}}\" = \"true\" ]; then STATE=\"execute\"; fi\n\necho \"{\\\"state\\\": \\\"$STATE\\\", \\\"context_path\\\": \\\"$CONTEXT_FILE\\\", \\\"locked_path\\\": \\\"$LOCKED_FILE\\\"}\""
      },
      "id": "CheckState",
      "name": "Check State (Refine vs Execute)",
      "type": "n8n-nodes-base.executeCommand",
      "typeVersion": 1,
      "position": [500, 300]
    },
    {
      "parameters": {
        "conditions": {
          "string": [
            {
              "value1": "={{$node['CheckState'].json.stdout}}",
              "operation": "contains",
              "value2": "\"state\": \"execute\""
            }
          ]
        }
      },
      "id": "IsLocked",
      "name": "Is Locked?",
      "type": "n8n-nodes-base.if",
      "typeVersion": 2,
      "position": [700, 300]
    },
    {
      "parameters": {
        "method": "POST",
        "url": "={{$env.OPENCLAW_BASE_URL}}/v1/responses",
        "authentication": "predefinedCredentialType",
        "nodeCredentialType": "httpHeaderAuth",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Authorization",
              "value": "={{'Bearer ' + $env.OPENCLAW_GATEWAY_TOKEN}}"
            }
          ]
        },
        "sendBody": true,
        "contentType": "json",
        "jsonParameters": true,
        "bodyParametersJson": "={{JSON.stringify({\n  model: 'openclaw:main',\n  temperature: 0.2,\n  input: [\n    {\n      role: 'system',\n      content: [\n        'You are the Spec Kit Refiner running in OpenClaw (a self-hosted AI agent gateway).',\n        'You must ask ONLY the minimum questions so a CLI implementer can create: constitution, specification, plan, tasks, and implement.',\n        'You KNOW the Spec Kit flow (constitution → specify → plan → tasks → implement) and gather inputs for:',\n        '  [Repo]: Owner, Name, Visibility, Primary implementer (gemini/copilot/both)',\n        '  [Constitution]: Constraints (Testing? Strict lint? Minimal deps? Security?)',\n        '  [Spec]: Product Goal (1 sentence), Target User, Acceptance Criteria (3-7), Non-goals',\n        '  [Plan]: Stack (FastAPI/Next.js/Fullstack), Deploy target, Auth model, Data/storage',\n        '  [Validation]: Exact commands to verify (e.g. pytest && ruff check .)',\n        'DO NOT create repo, run commands, or write spec/plan/tasks. Only refine.',\n        'Max 2-3 questions per turn. Always provide sensible defaults.',\n        'Return ONLY JSON: {phase:refine, run_id, needs_input, questions:[{key,q,default}], defaults, summary_so_far, locked (only when needs_input=false)}',\n        'locked MUST contain: project_intent, definition_of_done, non_goals, validation_commands, risk_notes, repo_params{owner,name,visibility}, primary_mode, template, constitution_constraints'\n      ].join('\\n')\n    },\n    {\n      role: 'user',\n      content: JSON.stringify({\n        run_id: $node['Context'].json.run_id,\n        app_name: $node['Context'].json.app_name,\n        github_owner: $node['Context'].json.github_owner,\n        defaults: $node['Context'].json.defaults,\n        current_message: $node['Context'].json.user_message,\n        context_path: $node['Context'].json.run_dir + '/context.json'\n      })\n    }\n  ]\n})}}"
      },
      "id": "RefineLLM",
      "name": "Call OpenClaw (Refine)",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4,
      "position": [900, 100]
    },
    {
      "parameters": {
        "mode": "runOnceForEachItem",
        "jsCode": "const content = ($json.output?.[0]?.content?.[0]?.text || $json.choices?.[0]?.message?.content || '').trim();\nlet parsed;\ntry { parsed = JSON.parse(content); }\ncatch(e) { parsed = { phase:'refine', needs_input:true, questions:[{key:'error',q:'OpenClaw did not return valid JSON.'}], raw:content }; }\nreturn { json: parsed };"
      },
      "id": "ParseRefine",
      "name": "Parse Refine Output",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [1100, 100]
    },
    {
      "parameters": {
        "conditions": {
          "boolean": [
            {
              "value1": "={{$json.needs_input}}",
              "value2": true
            }
          ]
        }
      },
      "id": "NeedsInput",
      "name": "Needs Input?",
      "type": "n8n-nodes-base.if",
      "typeVersion": 2,
      "position": [1300, 100]
    },
    {
      "parameters": {
        "command": "bash",
        "input": "-lc",
        "args": "set -euo pipefail\nRUN_DIR=\"{{$node['Context'].json.run_dir}}\"\nLOCKED='{{JSON.stringify($json.locked)}}'\necho \"$LOCKED\" > \"$RUN_DIR/locked.json\"\necho '{\"status\":\"locked\"}' > \"$RUN_DIR/context.json\"\necho \"[$(date -Is)] LOCKED: payload saved\" >> \"$RUN_DIR/openclaw.log\"\n"
      },
      "id": "SaveLocked",
      "name": "Save Locked State",
      "type": "n8n-nodes-base.executeCommand",
      "typeVersion": 1,
      "position": [1500, 200]
    },
    {
      "parameters": {
        "command": "bash",
        "input": "-lc",
        "args": "set -euo pipefail\nRUN_DIR=\"{{$node['Context'].json.run_dir}}\"\nLOCKED_FILE=\"$RUN_DIR/locked.json\"\nWORK_ROOT=\"{{$env.WORK_ROOT || '/data/janagi-builds'}}\"\n\necho \"[$(date -Is)] EXECUTE: starting build\" >> \"$RUN_DIR/openclaw.log\"\n\n/root/janAGI/ops/scripts/openclaw_spec_execute.sh \\\n  \"$LOCKED_FILE\" \"$RUN_DIR\" \"$WORK_ROOT\" \\\n  2>&1 | tee -a \"$RUN_DIR/openclaw.log\"\n\necho \"[$(date -Is)] EXECUTE: finished\" >> \"$RUN_DIR/openclaw.log\"\n\nif [ -f \"$RUN_DIR/result.json\" ]; then cat \"$RUN_DIR/result.json\";\nelse echo '{\"status\":\"failure\",\"error\":\"No result.json\"}'; fi\n"
      },
      "id": "ExecuteScript",
      "name": "EXECUTE (Script)",
      "type": "n8n-nodes-base.executeCommand",
      "typeVersion": 1,
      "position": [1700, 300]
    },
    {
      "parameters": {
        "responseBody": "={{JSON.stringify({run_id:$node['Context'].json.run_id, app_name:$node['Context'].json.app_name, run_dir:$node['Context'].json.run_dir, refine:$json}, null, 2)}}",
        "options": {}
      },
      "id": "RespondQuestions",
      "name": "Respond (Questions)",
      "type": "n8n-nodes-base.respondToWebhook",
      "typeVersion": 1,
      "position": [1500, -100]
    },
    {
      "parameters": {
        "responseBody": "={{$node['ExecuteScript'].json.stdout || JSON.stringify({status:'done', run_id:$node['Context'].json.run_id})}}",
        "options": {}
      },
      "id": "RespondResult",
      "name": "Respond (Done)",
      "type": "n8n-nodes-base.respondToWebhook",
      "typeVersion": 1,
      "position": [1900, 300]
    }
  ],
  "connections": {
    "Webhook (Message In)": { "main": [[{ "node": "Init Context", "type": "main", "index": 0 }]] },
    "Init Context": { "main": [[{ "node": "Check State (Refine vs Execute)", "type": "main", "index": 0 }]] },
    "Check State (Refine vs Execute)": { "main": [[{ "node": "Is Locked?", "type": "main", "index": 0 }]] },
    "Is Locked?": {
      "main": [
        [{ "node": "EXECUTE (Script)", "type": "main", "index": 0 }],
        [{ "node": "Call OpenClaw (Refine)", "type": "main", "index": 0 }]
      ]
    },
    "Call OpenClaw (Refine)": { "main": [[{ "node": "Parse Refine Output", "type": "main", "index": 0 }]] },
    "Parse Refine Output": { "main": [[{ "node": "Needs Input?", "type": "main", "index": 0 }]] },
    "Needs Input?": {
      "main": [
        [{ "node": "Respond (Questions)", "type": "main", "index": 0 }],
        [{ "node": "Save Locked State", "type": "main", "index": 0 }]
      ]
    },
    "Save Locked State": { "main": [[{ "node": "EXECUTE (Script)", "type": "main", "index": 0 }]] },
    "EXECUTE (Script)": { "main": [[{ "node": "Respond (Done)", "type": "main", "index": 0 }]] }
  },
  "active": false,
  "versionId": "2"
}
